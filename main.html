<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>THE GAME</title>

<style>
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  font-family: "Times New Roman", Times, serif;
}

body {
  background: linear-gradient(
    90deg,
    #ff0033,
    #ff7a00,
    #ffee00,
    #33ff00,
    #00ffd5,
    #0066ff,
    #7a00ff,
    #ff00aa
  );
}

/* ---------- START SCREEN ---------- */
#startScreen {
  position: fixed;
  inset: 0;
  background: black;
  display: flex;
  flex-direction: column;
  align-items: center;
  z-index: 20;
}

#titleImg {
  width: 70%;
  max-width: 900px;
  margin-top: 12vh;
  animation: float 2.5s ease-in-out infinite;
}

@keyframes float {
  0% { transform: translateY(0); }
  50% { transform: translateY(-14px); }
  100% { transform: translateY(0); }
}

#gameBtn {
  margin-top: 40px;
  cursor: pointer;
}

.fadeOut {
  animation: fade 0.35s forwards;
}

@keyframes fade {
  to { opacity: 0; }
}

/* ---------- GAME UI ---------- */
#ui {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 10;
  font-size: 18px;
  font-weight: bold;
  color: black;
}

#ui button {
  font-family: inherit;
  font-weight: bold;
  margin-right: 8px;
  cursor: pointer;
}

/* ---------- FIELD ---------- */
#field {
  position: relative;
  width: 100%;
  height: 100%;
}

/* ---------- CATS ---------- */
.cat {
  position: absolute;
  pointer-events: none;
  user-select: none;
  filter: drop-shadow(0 12px 18px rgba(0,0,0,0.35));
}

.cat img {
  width: 220px;
}

.vibrate {
  animation: vibrate 0.06s infinite;
}

@keyframes vibrate {
  0%   { transform: translate(0,0); }
  25%  { transform: translate(2px,-2px); }
  50%  { transform: translate(-2px,2px); }
  75%  { transform: translate(2px,2px); }
  100% { transform: translate(0,0); }
}

/* ---------- EXPLOSIONS ---------- */
.explosion {
  position: absolute;
  pointer-events: none;
  z-index: 15;
}
</style>
</head>

<body>

<!-- START SCREEN -->
<div id="startScreen">
  <img id="titleImg" src="FCK-removebg-preview.png">
  <img id="gameBtn" src="the-game.PNG">
</div>

<!-- UI -->
<div id="ui" style="display:none">
  dB: <span id="db">--</span>
  Screaming: <span id="count">0</span>/<span id="total">0</span>
</div>

<!-- FIELD -->
<div id="field"></div>

<script>
/* ---------- SETUP ---------- */
const body = document.body;
  
const CAT_NUMBERS = [1,2,3,4];
const DUPLICATES = 2;

const REF_RMS = 0.005;
const BASE_DB = 10;
const DB_PER_CAT = 6;

const cats = [];
const field = document.getElementById("field");

function imgPath(type,n){ return encodeURIComponent(`${type} ${n}.webp`); }

/* ---------- CREATE CATS ---------- */
for (const n of CAT_NUMBERS){
  for (let i=0;i<DUPLICATES;i++){
    const d = document.createElement("div");
    d.className = "cat";
    const img = document.createElement("img");
    img.src = imgPath("normal",n);
    d.appendChild(img);
    field.appendChild(d);
    cats.push({d,img,n});
  }
}
document.getElementById("total").textContent = cats.length;

/* ---------- SPRINKLE LAYOUT ---------- */
function sprinkle(){
  const W = innerWidth, H = innerHeight;
  const cols = Math.ceil(Math.sqrt(cats.length * W / H));
  const rows = Math.ceil(cats.length / cols);
  const cw = W / cols, ch = H / rows;

  let i=0;
  for (let r=0;r<rows;r++){
    for (let c=0;c<cols;c++){
      if (i>=cats.length) return;
      const jx = (Math.random()-0.5)*cw*0.5;
      const jy = (Math.random()-0.5)*ch*0.5;
      cats[i].d.style.left = c*cw + cw/2 + jx - 110 + "px";
      cats[i].d.style.top  = r*ch + ch/2 + jy - 110 + "px";
      cats[i].d.style.transform = `rotate(${Math.random()*30-15}deg)`;
      i++;
    }
  }
}
sprinkle();
addEventListener("resize", sprinkle);

/* ---------- AUDIO ---------- */
let audioCtx, analyser, stream, raf;
const dbEl = document.getElementById("db");
const countEl = document.getElementById("count");

function rmsToDb(r){ return 20*Math.log10(Math.max(r,1e-8)/REF_RMS); }

let maxMode = false;
let exitTimer = null;

function spawnExplosion(){
  const img = document.createElement("img");
  img.className = "explosion";
  img.src = Math.random()<0.5 ? "explosions.gif" : "explosions2.gif";
  img.style.left = Math.random()*(innerWidth-200)+"px";
  img.style.top  = Math.random()*(innerHeight-200)+"px";
  img.style.width = 120 + Math.random()*200 + "px";
  field.appendChild(img);
  setTimeout(()=>img.remove(),1000);
}

function enterMax(){
  if (maxMode) return;
  maxMode = true;
  body.style.background = `url("hell.png") center/cover fixed`;
  for (let i=0;i<12;i++) spawnExplosion();
}

function exitMax(){
  maxMode = false;
  body.style.background = "";
}

function loop(){
  const buf = new Float32Array(analyser.fftSize);
  analyser.getFloatTimeDomainData(buf);
  let sum=0; for (const x of buf) sum+=x*x;
  const rms = Math.sqrt(sum/buf.length);
  const db = rmsToDb(rms);
  dbEl.textContent = db.toFixed(1);

  let screaming = 0;
  if (db >= BASE_DB)
    screaming = Math.min(cats.length,1+Math.floor((db-BASE_DB)/DB_PER_CAT));

  countEl.textContent = screaming;

  cats.forEach((c,i)=>{
    const s = i < screaming;
    c.img.src = imgPath(s?"scream":"normal",c.n);
    c.d.classList.toggle("vibrate",s);
  });

  if (screaming === cats.length){
    enterMax();
    if (Math.random() < Math.min(0.25, db/60)) spawnExplosion();
    if (exitTimer){ clearTimeout(exitTimer); exitTimer=null; }
  } else if (maxMode && !exitTimer){
    exitTimer = setTimeout(()=>{ exitMax(); exitTimer=null; },3000);
  }

  raf = requestAnimationFrame(loop);
}

async function startMic(){
  stream = await navigator.mediaDevices.getUserMedia({audio:true});
  audioCtx = new AudioContext();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  audioCtx.createMediaStreamSource(stream).connect(analyser);
  loop();
}

/* ---------- START BUTTON ---------- */
document.getElementById("gameBtn").onclick = ()=>{
  document.getElementById("titleImg").classList.add("fadeOut");
  document.getElementById("startScreen").classList.add("fadeOut");
  setTimeout(()=>{
    startScreen.remove();
    document.getElementById("ui").style.display="block";
    startMic();
  },350);
};
</script>
</body>
</html>
